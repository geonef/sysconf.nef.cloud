# NEF SERVICE 'mx'               -*- shell-script -*-

NEF_SERVICE_NUMBER=15
NEF_SERVICE_SYSCONF=nef.service.mx

NEF_SERVICE_UPDATE()
{
    echo "mx UPDATE ==================="
    nef_service_common_update
    nef_service_mx_update_dkim
    nef_service_mx_update_postfix
}

NEF_SERVICE_UPDATE_APPS()
{
    echo "mx UPDATE APPS ==================="
}

# OpenDKIM: check /etc/mail/dkim.*.private entries
#   - restrict to those known by DNS
#   - take the last one and use it in OpenDKIM
nef_service_mx_update_dkim()
{
    nef_cloud_log "updating DKIM configuration"
    etcDkim=/etc/dkim
    chown opendkim:opendkim -R $etcDkim

    NEF_SERVICE_MX_DKIM_SELECTOR=$(
        (
            for file in $etcDkim/*.private; do
                selector=$(basename $file .private)
                selectorHost=${selector}._domainkey.${NEF_SERVICE_MX_DOMAIN}
                publicKey=$(cat $etcDkim/$selector.txt | sed 's/.* p=\([^"]*\).*/\1/')
                if host -t TXT $selectorHost | grep -q "$publicKey"; then
                    nef_cloud_log "DKIM: selector '$selector' found in DNS as $selectorHost"
                    echo $selector
                else
                    nef_cloud_log "DKIM: selector '$selector' NOT found in DNS as $selectorHost, ignoring"
                fi
            done
        ) | tail -n 1
    )
    if test "$NEF_SERVICE_MX_DKIM_SELECTOR" = ""; then
        nef_cloud_log "not configuring DKIM: no selector"
        service opendkim stop
    else
        nef_cloud_log "configuring DKIM for selector: $NEF_SERVICE_MX_DKIM_SELECTOR"
        nef_template_apply_file $CLOUD_NEF_TEMPLATES_PATH/service.mx.opendkim.conf >/etc/opendkim.conf
        echo -e "# GENERATED BY nef-cloud service:mx\nSOCKET=\"inet:8891@localhost\"" >/etc/default/opendkim
        cat <<EOF >/etc/dkim/InternalHosts
127.0.0.1/8
$(nef_info_node_cloud_network --with-prefix)
EOF
        if service opendkim status | grep -q "is running"; then
            service opendkim restart && nef_cloud_log "Restarted opendkim"
        else
            service opendkim start && nef_cloud_log "Started opendkim"
        fi
    fi
}

nef_service_mx_update_postfix()
{
    postfixConf=/etc/postfix/main.cf
    nef_cloud_log "Regenerating postfix config: $postfixConf"
    nef_template_apply_file $CLOUD_NEF_TEMPLATES_PATH/service.mx.postfix.main.cf >$postfixConf

    if service postfix status | grep -q "is running"; then
        service postfix reload && nef_cloud_log "Reloaded postfix"
    else
        service postfix start && nef_cloud_log "Started postfix"
    fi
}
